---
title: "サブスクリプションモデルの運用設計"
emoji: "📊"
type: "tech"
topics: ["BigQuery","SQL"]
published: false
---

## はじめに
こんにちは。[Unlace](https://www.unlace.net/?utm_campaign=unlace_f_tech_zenn)でエンジニアをしている、栗栖([@ryomak](https://twitter.com/ryomak_13))です。  

前回は、決済基盤についての前半の記事、Stripeの導入~実装について記事を書きました。
https://zenn.dev/ryomak/articles/stripe-operation

この記事は決済基盤の記事の後半です。 サブスクリプションに関する分析観点でのDB設計をまとめると共に、実際にどのようにクエリで実現しているのかを書きます。

分析の目的は良いビジネスの意思決定をするためにあります。
特に決済は会社の売上直結するため、決済まわりの分析は、事業判断の指標になるためより重要だと考えています。

最初Stripeを導入する際、上記分析を考慮しましたが、 概念や概念を実装に落とし込むことがとても難易度が高いと感じました。
社長経由で繋いでもらった優秀なデータアナリストの方に相談しながら、実装しました。
今回はこちらの知見をまとめていきます。

## 前提・背景
### 課金の流れ
ユーザは、カウンセラーとカウンセリングをしている間料金が発生します。
カウンセリング流れは以下です。
![](/images/subscription/counseling_loop.png)
カウンセリングに対して、サブスクリプションのステータスが更新されます。
1. ユーザが会員登録する
2. ユーザがカウンセリングを開始する際に、サブスクリプションが開始される
3. カウンセリングが続く間は、サブスクリプションは継続
4. カウンセリングを終了すると、サブスクリプションが解約
5. カウンセリングを再開すると、サブスクリプションが再度開始される
### Unlaceにおける売り上げのKPI指標
Unlaceではユーザの課金に対するKPIを以下のように設定しています。
![](/images/subscription/kpi.png)

| 名称   | 　定義                        | カウンセリング |
|------|----------------------------|-----------------------------------------------------------------------|
| Regs | サービス登録者                    | 入金処理は着金日の2日以上前から作成されるため、入金処理から着金までの期間の支払いは次回以降に持ち越しになる                |
| 手動入金 | アプリケーション側で自由なタイミングで入金処理ができる | 着金には入金処理から1〜2営業日かかる(銀行側のシステム都合で2〜3営業日ずれる場合あり)。<br>着金日が土日祝日の場合、翌営業日に着金 |



