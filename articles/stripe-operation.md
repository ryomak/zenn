---
title: "UnlaceでStripeを導入・運用して気づいた5つの壁と乗り越え方"
emoji: "😚"
type: "tech"
topics: ["Stripe","Go"]
published: false
---

## はじめに

こんにちは。[Unlace](https://www.unlace.net/?utm_campaign=unlace_f_tech_zenn)でエンジニアをしている、ryomakです。  
前職はヤフー株式会社で決済システムの開発・運用業務をしていて、
2020年からUnlaceにJoinし、主にUnlaceのバックエンドをで開発しています。

### Unlaceについて
[Unlace](https://www.unlace.net/?utm_campaign=unlace_f_article_zenn)は、主にユーザ向けのテキストカウンセリングを含むメンタルヘルスケアのサービスを提供しています。  

(Unlaceがわかる画像)

加えて、登録カウンセラーの方が利用するUnlace for counselorや、企業が従業員に対してUnlaceの利用料金を負担する仕組みを提供する[Unlace for business](https://www.unlace.net/business?utm_campaign=unlace_f_tech_zenn)も提供しています。



Unlaceでは、サービスの決済基盤としてStripeを導入しております。

この記事では、決済基盤の技術選定と具体的な実装内容、そして、運用する中で得た気づきを、Unlaceでの活用事例として紹介します！

## 導入背景
Unlaceでは、APIサーバーにはGo、ユーザ・カウンセラー向けのWeb/AppをReact Nativeを採用しています。  
フロント周りの構成に関しては、弊社フロントエンジニアが書いているこちらの記事をご覧ください。  
[React & ReactNativeのmonorepo環境にViteを導入する](https://zenn.dev/yuto_iwashita/articles/vite-monorepo)

サービスをリリースした当初は、公式LINEアカウントを利用してカウンセラーとカウンセリングができるというサービスをβ版として提供をしていました。  
決済については、LINE Payを用いて決済管理をしていましたが、LINEから自社のチャットシステムを載せ替えるにあたって、制限が多かったため、別の決済基盤に載せ替える必要がありました。


## Unlaceにおける決済システム設計

## 最初に読んでおいた方が良いドキュメント

## 第1の壁: サブスクリプションのインボイスの確定に1時間のラグが存在する
## 第2の壁：決済失敗時のサブスクリプションの管理
## 第3の壁：請求サイクルを伸ばす
## 第4の壁：カウンセラーへの入金ロジック
## 第5の壁：入金スケジュール

## Appendix: Stripeで良かったところ
### サポートが充実
Stripeはサポートが充実しています。
2022年7月現在はチャットとメールがあり、丁寧に仕様や原因を教えていただけます。
- チャット：　数分でレスポンス（対応:英語のみ)
- メール：1営業日ほどでレスポンス

要件の実現方法を相談して開発を進めました。
緊急度によってチャットとメールを使い分けていました。

### 管理画面が強力
Stripeでは、ユーザの管理ができる管理画面が提供されています。
基本的な作業については、全てこの管理画面で完結します。
Unlaceの場合は、StripeのデータとUnlaceの管理画面データを同期させるために、Webhookを受け取って、よしなに反映しています。

## Appendix: つまづいた仕様
### 管理画面ホームの売上額は正しくない場合がある。
管理画面のホームトップに表示される売上額が正しくないことがあります。
問い合わせたところ、以下の回答をいただきました。
- ホーム画面にあるレポートはリアルタイムのデータを提供する目的
- 会計グレードの精度で提供するように設計されていない
- データのズレはシステムで自動的に修正されるように設計されている

### 決済金額が0円の時のWebhookのinvoiceオブジェクトのパラメータが異なる
サブスクリプションの支払い成功のイベント(`payment_succeeded`)は、invoiceオブジェクトがbodyに含まれています。
クーポン等を利用して、サブスクリプションの次の支払い金額が0円の場合は、chargeが発生しないため、chargeがnullで返却されるので注意が必要です。
```go
var chargeID *string
if invoice.Charge != nil {
    chargeID = &invoice.Charge.ID
}
```

### 通常のWebhook と ConnectのWebhookの設定
通常のイベントを受け取るWebhookで、Connectでの審査結果等のイベント名が表示されますが通常のwebhookで設定してもイベントが通知されることはありません。
Connectで利用するイベントは別途Webhookを設定する必要があります。以下画像の「連結アカウントでイベントをリッスンする」にチェックすると、受け取ることができます。
![](/images/stripe-operation/connect_webhook.png)


### 分析用途の設計をしておく
Unlaceはサブスクリプションモデルで、ユーザの属性ごとなど、あらゆるコホートでの分析をしています。

決済基盤にバグがあると売り上げに直結するため、一度決めた設計は変更するのには慎重になる必要があります。
Unlaceにおいては幸い、データ数が少ない初期の段階に、弊社CEOの前職のでPairsのデータアナリストの方監修していただいております。

細かい要件がなければ、Stripeの管理画面でもある程度分析をみることができるので、細かい分析が必要ない場合は、

## まとめ


## さいごに
Unlaceは2020年12月にサービス開始してから、成長し続けています。
2022年にプレAシリーズで資金調達を完了したところで、これからより大きなサービスになっていきます。

2022年7月現在、開発エンジニアは2人で3サービスを開発しており、 まだまだたくさんのエンジニアが必要です！
ユーザの価値貢献につながるサービスを一緒に作りませんか？

[採用要項](https://job.unlace.net/)

